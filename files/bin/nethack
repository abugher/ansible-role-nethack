#!/bin/bash

                 nethack='/usr/local/games/nethack'
                 version=$(head -n 2 $nethack | tail -n 1 | awk '{print $3}')
         local_bones_dir='/usr/local/games/lib/nethackdir'
             mount_point="/tmp/bones"
        remote_bones_dir="${mount_point}/${version}"
 remote_remote_bones_dir="cryptkeeper@neuronpointer.net:bones"
                lock_dir=".lock_dir"
                 uidfile='/tmp/uidfile'
                 gidfile='/tmp/gidfile'
              remote_uid='995'
              remote_gid='992'
             bones_files=()
            lock_timeout=10


function puke {
  ret=$1
  shift
  echo "BLEAH:  ${@}"
  exit $ret
}


mount_remote_bones_dir() {
  login_gid=$( awk -F : "/^$USER:/"' {print $3}' /etc/passwd )
  echo $login_gid | grep -qE '^[0-9]*$' || puke 1 "Invalid login UID:  ${login_uid}"
  login_group=$( awk -F : "/:$login_gid:/"' {print $1}' /etc/passwd )
  echo $login_group | grep -qE '^[a-zA-Z0-9\._][a-zA-Z0-9\._\-]*$' || puke 1 "Invalid login group:  ${login_group}"
  echo "${USER}:${remote_uid}" > $uidfile
  echo "${login_group}:${remote_gid}" > $gidfile
  fusermount -u $mount_point 2>&1 >/dev/null
  fusermount_ret=$?
  if mountpoint $mount_point > /dev/null; then
    puke $fusermount_ret "Failed to unmount:  ${mount_point}"
  fi
  mkdir -p $mount_point || puke $? "Failed to mkdir:  ${mount_point}"
  sshfs \
    -o idmap=file,uidfile=$uidfile,gidfile=$gidfile,reconnect \
    $remote_remote_bones_dir $mount_point || puke $? "Failed to mount:  ${mount_point}"
}


lock() {
  file_lock_dir="${1}"
  i=0
  while ! test -f $file_lock_dir/pid.$$; do
    while ! mkdir $file_lock_dir > /dev/null 2>&1; do
      if rmdir $file_lock_dir > /dev/null 2>&1; then
        continue
      fi
      if test $i -ge $lock_timeout; then
        puke $? "Failed to acquire lock."
      fi
      for pid_file in $file_lock_dir/pid.*; do
        pid=$(sed 's/.*\.//g' <<< $pid_file)
        read user < $pid_file
        echo "Lock held by ${user} for PID:  ${pid}"
      done
      sleep 1
      i=$((i+1))
    done

    echo $USER@$HOSTNAME > $file_lock_dir/pid.$$
  done
}


lock_dir() {
  dir="${1}"
  lock "${dir}/${lock_dir}"
  #echo "Locked:  ${dir}"
}


unlock_dir() {
  dir="${1}"
  rm $dir/$lock_dir/pid.$$ || puke $? "Failed to remove PID file."
  rmdir $dir/$lock_dir || puke $? "Failed to remove lock file."
  #echo "Unlocked:  ${dir}"
}


lock_file() {
  file="${1}"
  file_lock_dir=$(sed -E 's/\/([^\/]*)$/\/.lock.\1/' <<< $file)
  lock $file_lock_dir
  #echo "Locked:  $file"
}


unlock_file() {
  file="${1}"
  file_lock_dir=$(sed -E 's/\/([^\/]*)$/\/.lock.\1/' <<< $file)
  rm $file_lock_dir/pid.$$ || puke $? "Failed to remove PID file."
  rmdir $file_lock_dir || puke $? "Failed to remove lock file."
  #echo "Unlocked:  ${file}"
}


file_is_locked() {
  file="${1}"
  file_lock_dir=$(sed -E 's/\/([^\/]*)$/\/.lock.\1/' <<< $file)
  test -d $file_lock_dir
}


release_bones_files() {
  for bones_file in "${bones_files[@]}"; do
    unlock_file $local_bones_dir/$bones_file
  done

  unset bones_files
}


upload_bones_files() {
  lock_dir $remote_bones_dir
  mkdir -p "${remote_bones_dir}" || puke $? "Failed to create shared bones directory:  ${remote_bones_dir}"
  for bones_file in $(ls $local_bones_dir | grep '^bon') ; do
    bones_file=$(echo $bones_file | sed 's/.*\///g')
    if ! file_is_locked $local_bones_dir/$bones_file; then
      mv $local_bones_dir/$bones_file $remote_bones_dir/$bones_file || puke $? "Failed to move:  ${bones_file}"
      echo "Uploaded: ${bones_file}"
    else
      echo "Skipped (locked):  ${bones_file}"
    fi
  done
  unlock_dir $remote_bones_dir
}


download_bones_files() {
  lock_dir $remote_bones_dir
  available_count=$(ls $remote_bones_dir | grep ^bon | wc -l)
  download_quota=$(( $available_count / 2 ))
  if test 1 -eq $available_count; then
    download_quota=1
  fi

  download_count=0
  for bones_file in $(ls $remote_bones_dir | grep ^bon | sort -R); do
    if test $download_count -ge $download_quota; then break; fi
    bones_files+=( $bones_file )
    lock_file $local_bones_dir/$bones_file
    mv $remote_bones_dir/$bones_file $local_bones_dir/$bones_file || puke $? "failed to move ${bones_file}"
    echo "Downloaded: ${bones_file}"
    let download_count++
  done
  unlock_dir $remote_bones_dir
}


play() {
  echo "Starting nethack."
  $nethack

  echo "nethack returned:  $?"
}


mount_remote_bones_dir
upload_bones_files
download_bones_files
play
release_bones_files
upload_bones_files
